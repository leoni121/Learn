[TOC]

> [【高并发解决方案】5、如何设计一个秒杀系统](https://www.cnblogs.com/wangzhongqiu/p/6557596.html)

## 1. 秒杀系统场景特点 ##

- 秒杀时大量用户会在同一时间同时进行抢购，网站瞬时**访问流量**激增。
- 秒杀一般是访问**请求数量远远大于库存数量**，只有少部分用户能够秒杀成功。
- 秒杀业务流程比较简单，一般就是**下订单减库存**。

## 2. 秒杀架构设计理念 ##

**限流：** 鉴于只有少部分用户能够秒杀成功，所以要限制大部分流量，只允许少部分流量进入服务后端。

**削峰：**对于秒杀系统瞬时会有大量用户涌入，所以在抢购一开始会有很高的瞬间峰值。高峰值流量是压垮系统很重要的原因，所以如何把瞬间的高流量变成一段时间平稳的流量也是设计秒杀系统很重要的思路。实现削峰的常用的方法有利用缓存和消息中间件等技术。

**异步处理：**秒杀系统是一个高并发系统，采用异步处理模式可以极大地提高系统并发量，其实异步处理就是削峰的一种实现方式。

**内存缓存：**秒杀系统最大的瓶颈一般都是[数据库](http://lib.csdn.net/base/mysql)读写，由于数据库读写属于磁盘IO，性能很低，如果能够把部分数据或业务逻辑转移到内存缓存，效率会有极大地提升。

**可拓展：**当然如果我们想支持更多用户，更大的并发，最好就将系统设计成弹性可拓展的，如果流量来了，拓展机器就好了。像淘宝、京东等双十一活动时会增加大量机器应对交易高峰。

## 3. 前端方案 ##

* **页面静态化：**将活动页面上的所有可以静态的元素全部静态化，并尽量减少动态元素。通过CDN来抗峰值。 
* **禁止重复提交：**用户提交之后按钮置灰，禁止重复提交 
* **用户限流：**在某一时间段内只允许用户提交一次请求，比如可以采取IP限流

## 4. 后端方案 ##

### 4.1 服务端控制器层(网关层) ###

**限制uid（UserID）访问频率：**我们上面拦截了浏览器访问的请求，但针对某些恶意攻击或其它插件，在服务端控制层需要针对同一个访问uid，限制访问频率。

### 4.2 服务层 ###

上面只拦截了一部分访问请求，当秒杀的用户量很大时，即使每个用户只有一个请求，到服务层的请求数量还是很大。比如我们有100W用户同时抢100台手机，服务层并发请求压力至少为100W。

1. **采用消息队列缓存 请求：**既然服务层知道库存只有100台手机，那完全没有必要把100W个请求都传递到数据库啊，那么可以**先把这些请求都写到消息队列缓存一下，数据库层订阅消息减库存，减库存成功的请求返回秒杀成功，失败的返回秒杀结束。**
2. **利用缓存应对 读请求：**对类似于12306等购票业务，是典型的读多写少业务，大部分请求是查询请求，所以**可以利用缓存分担数据库压力**。
3. **利用缓存应对 写请求：**缓存也是可以应对写请求的，比如**我们就可以把数据库中的库存数据转移到Redis缓存中，所有减库存操作都在Redis中进行**，然后再通过后台进程把Redis中的用户秒杀请求同步到数据库中。

## 5. 数据库层 ##

数据库层是最脆弱的一层，一般在应用设计时在上游就需要把请求拦截掉，数据库层只承担“能力范围内”的访问请求。所以，上面通过在服务层引入队列和缓存，让最底层的数据库高枕无忧。