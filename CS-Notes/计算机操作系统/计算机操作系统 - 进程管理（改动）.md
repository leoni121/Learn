[TOC]


# 进程与线程

## 1. 进程

### 1.1 概念

**进程**是**进程实体**的运行过程，是系统进行**资源分配**和**调度**的一个独立单位。

> 其他：
>
> 1. 进程是程序及其数据在处理机上顺序执行时所发生的活动。
> 2. 进程是程序的一次执行。

**进程控制块** (Process Control Block, PCB) ，为描述**进程的基本信息**和**运行状态**配置的专门的数据结构，所谓的创建进程和撤销进程，都是指对 PCB 的操作。

> 进程实体（进程）= 程序段 + 相关的数据段 + PCB

### 1.2 特性

1. 动态性
2. 并发性
3. 异步性
4. 独立性

## 2. 线程

**线程是独立调度和分派的基本单位。被包含在[进程](https://baike.baidu.com/item/进程)之中，是[进程](https://baike.baidu.com/item/进程)中的实际运作单位。**

一个进程中可以有多个线程，它们共享进程资源。

QQ 和浏览器是两个进程，浏览器进程里面有很多线程，例如 异步HTTP 请求线程、定时器触发线程、事件触发线程、GUI渲染线程、JS线程等等，线程的并发执行使得在浏览器中点击一个新链接从而发起 HTTP 请求时，浏览器还可以响应用户的其它事件。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/3cd630ea-017c-488d-ad1d-732b4efeddf5.png"/> </div><br>
## 3. 区别

1. 拥有资源

   进程是资源分配的基本单位，但是线程不拥有资源（仅拥有一些必不可少的、能保证独立运行的资源），线程可以访问隶属进程的资源。

2. 调度的基本单位

   线程是独立调度的基本单位

   同一进程的线程切换不会引起进程切换。

   不同进程的线程切换会引起进程切换。

3. 系统开销

   由于**创建或撤销进程时**，**系统都要为之分配或回收资源，如内存空间、I/O 设备等，所付出的开销远大于创建或撤销线程时的开销**。类似地，在进行**进程切换时**，涉及当前**执行进程 CPU 环境的保存及新调度进程 CPU 环境的设置，**而线程切换时只需保存和设置少量寄存器内容，开销很小。

4. 并发性

   更好的并发性，多线程之间也可以并发运行。

6. 支持多处理机系统

   多线程进程可以将线程分配到多处理机上，使他们并行执行。

6. 独立性

   线程的独立性低于进程之间的独立性。

7. 可靠性

   进程间不相互影响，一个线程挂掉将导致整个进程挂掉。

# 什么时候用多线程?什么时候用多进程？

1. 需要**频繁创建销毁**的优先用线程,**并行操作时**使用线程**，**

   C/S[架构](http://lib.csdn.net/base/architecture)的服务器端并发线程响应用户的请求

2. **大量计算**，切换频繁时用线程

   **大量计算**，当然就是要耗费很多CPU，**切换频繁**了。（**图像处理、算法处理**）

3. **耗时的操作**（提高**响应**）

4. **强相关的处理用线程，弱相关的处理用进程**
   **弱相关**：**消息收发、消息处理**。

   **强相关**：“消息处理”里面可能又分为**“消息解码”、“业务处理”**。

5. **多机分布的用进程**，**多核分布的用线程**。

6. 更**稳定更安全**时，适合选择进程。

# 进程状态的切换

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ProcessState.png" width="500"/></div><br>
- 就绪状态（ready）：等待被调度
- 运行状态（running）
- 阻塞状态（waiting）：等待资源

应该注意以下内容：

- 只有**就绪态和运行态可以相互转换**，其它的都是单向转换。**就绪状态的进程通过调度算法从而获得 CPU 时间，转为运行状态**；而**运行状态的进程，在分配给它的 CPU 时间片用完之后就会转为就绪状态**，等待下一次调度。
- **阻塞状态是缺少需要的资源从而由运行状态转换而来**，但是该资源不包括 CPU 时间，**缺少 CPU 时间会从运行态转换为就绪态。**

# 进程调度算法

不同环境的调度算法目标不同，因此需要针对不同环境来讨论调度算法。

## 1. 批处理系统

批处理系统**没有太多的用户操作**。

**1.1 先来先服务 first-come first-serverd（FCFS）** 

不利于短作业

**1.2 短作业优先 shortest job first（SJF）** 

**长作业有可能会饿死**

**1.3 最短剩余时间优先 shortest remaining time next（SRTN）** 

**最短作业优先的抢占式版本**。新的进程需要的时间更少，则挂起当前进程，运行新的进程。否则新的进程等待。

## 2. 交互式系统

**2.1 时间片轮转** 

**FCFS 的原则排成一个队列**，**时间片用完**，**调度程序便停止**，**送往就绪队列**

**2.2 优先级调度** 

**每个进程分配一个优先级**，**时间的推移增加等待进程的优先级。**

## 3. 实时系统

实时系统要求一个请求在一个**确定时间内得到响应**。

分为硬实时和软实时，前者必须满足绝对的截止时间，后者可以容忍一定的超时。

**最早截止时间优先**

**最低松弛度优先**（紧急情况）

# 进程同步

## 1. 临界区

对临界资源进行访问的那段代码称为临界区。

为了互斥访问临界资源，每个进程在进入临界区之前，需要先进行检查。

## 2. 同步与互斥

- 同步：多个进程因为合作产生的直接制约关系，使得进程有一定的先后执行关系。
- 互斥：多个进程在同一时刻只有一个进程能进入临界区。

## 3. 信号量

## 4. 管程

# 经典进程同步问题

## 1. 生产者和消费者问题

## 2. 读者-写者问题

允许多个进程同时对数据进行读操作，但是不允许读和写以及写和写操作同时发生。

一个整型变量 count 记录在对数据进行读操作的进程数量，一个互斥量 count_mutex 用于对 count 加锁，一个互斥量 data_mutex 用于对读写的数据加锁。


## 3. 哲学家进餐问题

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/a9077f06-7584-4f2b-8c20-3a8e46928820.jpg"/> </div><br>
五个哲学家围着一张圆桌，每个哲学家面前放着食物。哲学家的生活有两种交替活动：吃饭以及思考。当一个哲学家吃饭时，需要先拿起自己左右两边的两根筷子，并且一次只能拿起一根筷子。

# 进程通信

1. **共享储存器系统**（某些数据结构，储存区域）

2. **管道（pipe）通信系统**（一个读进程，一个写进程）

3. **消息传递系统**（操作系统）

4. **客户机-服务机系统**（Client-Server system）

   不同计算机间，套接字

